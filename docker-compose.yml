services:
  # =========================================================================
  # MONGODB - Banco de Dados da Aplicação
  # =========================================================================
  mongodb:
    image: mongo:6.0
    container_name: parlamd-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_DATABASE: parlamd
    volumes:
      - mongodb-data:/data/db
      - mongodb-logs:/var/log/mongodb
    networks:
      - parlamd-data
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/parlamd --quiet
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # =========================================================================
  # POSTGRESQL - Banco de Dados do Keycloak (IAM)
  # =========================================================================
  keycloak-postgres:
    image: postgres:15
    container_name: parlamd-keycloak-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: password
    volumes:
      - keycloak-postgres-data:/var/lib/postgresql/data
    networks:
      - parlamd-data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # =========================================================================
  # RABBITMQ - Message Broker
  # =========================================================================
  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: parlamd-rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - parlamd-app
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # =========================================================================
  # REDIS - Cache
  # =========================================================================
  redis:
    image: redis:7.2-alpine
    container_name: parlamd-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - parlamd-data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # =========================================================================
  # KEYCLOAK - IAM Service
  # =========================================================================
  keycloak:
    image: quay.io/keycloak/keycloak:23.0.7
    container_name: parlamd-keycloak
    restart: unless-stopped
    environment:
      # Conexão com Postgres
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: password
      
      # Credenciais Admin
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      
      # Configurações HTTP/Hostname
      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_LOG_LEVEL: INFO
      
      # Tunning JVM para evitar OOM no import
      JAVA_OPTS_APPEND: "-Xms512m -Xmx1024m"
    command:
      - start-dev
      - --import-realm
    ports:
      - "8180:8080" # Mapeamento Split Horizon (Externo 8180 -> Interno 8080)
    volumes:
      - ./docker/keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json
    networks:
      - parlamd-app
      - parlamd-data
    depends_on:
      keycloak-postgres:
        condition: service_healthy
    healthcheck:
      # Healthcheck via TCP para garantir que a porta está aberta
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e \"GET /health/ready HTTP/1.1\r\nhost: http://localhost\r\nConnection: close\r\n\r\n\" >&3;grep \"HTTP/1.1 200 OK\" <&3"]
      interval: 10s
      timeout: 10s
      retries: 15
      start_period: 90s

  # =========================================================================
  # OLLAMA - AI Service
  # =========================================================================
  ollama:
    image: ollama/ollama:latest
    container_name: parlamd-ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama-models:/root/.ollama
    networks:
      - parlamd-ai
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/version"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  # =========================================================================
  # BACKEND - Spring Boot
  # =========================================================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    image: parlamd-backend:latest
    container_name: parlamd-backend
    restart: unless-stopped
    environment:
      SPRING_PROFILES_ACTIVE: docker
      MONGODB_URI: mongodb://mongodb:27017/parlamd
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      OLLAMA_SERVER: http://ollama:11434
      
      # === SPLIT HORIZON FIX ===
      # Token emitido externamente tem 'iss': localhost:8180
      KEYCLOAK_ISSUER_URI: http://localhost:8180/realms/parlamd
      # Backend busca chaves internamente na rede Docker (porta 8080 original)
      KEYCLOAK_JWK_SET_URI: http://keycloak:8080/realms/parlamd/protocol/openid-connect/certs
      
      KEYCLOAK_AUTH_SERVER_URL: http://keycloak:8080
      KEYCLOAK_REALM: parlamd
      KEYCLOAK_CLIENT_ID: parla-md-client
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET:-RnMndotWYb52i2aNpIe2fQNb12kRUSxa}
      
      # Logs
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_BR_GOV_MD_PARLA_MD_BACKEND: DEBUG
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_SECURITY: DEBUG

    ports:
      - "8081:8081"
    volumes:
      - backend-logs:/app/logs
      - backend-temp:/tmp
    networks:
      - parlamd-app
      - parlamd-data
      - parlamd-ai
    depends_on:
      mongodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      keycloak:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          memory: 1G

networks:
  parlamd-app:
    driver: bridge
  parlamd-data:
    driver: bridge
  parlamd-ai:
    driver: bridge

volumes:
  mongodb-data:
    name: parlamd_mongodb_data
    driver: local
  mongodb-logs:
    name: parlamd_mongodb_logs
    driver: local
  rabbitmq-data:
    name: parlamd_rabbitmq_data
    driver: local
  redis-data:
    name: parlamd_redis_data
    driver: local
  keycloak-postgres-data:
    name: parlamd_keycloak_postgres_data
    driver: local
  ollama-models:
    name: parlamd_ollama_models
    driver: local
  backend-logs:
    name: parlamd_backend_logs
    driver: local
  backend-temp:
    name: parlamd_backend_temp
    driver: local