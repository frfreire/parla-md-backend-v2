# =========================================================================
# PARLA-MD - DOCKER COMPOSE CORRIGIDO PARA WINDOWS - RABBITMQ FIXED
# =========================================================================
# Correcoes aplicadas:
# - Healthcheck do Keycloak corrigido
# - PostgreSQL com inicializacao otimizada
# - Dependencias ajustadas para evitar falhas em cascata
# - RabbitMQ configurado para usar vhost padrao "/"
# - Configuracoes simplificadas para desenvolvimento
# Data: 2025-08-13
# =========================================================================

networks:
  parlamd-network:
    driver: bridge

volumes:
  mongodb_data:
    name: parlamd_mongodb_data
    driver: local
  rabbitmq_data:
    name: parlamd_rabbitmq_data
    driver: local
  redis_data:
    name: parlamd_redis_data
    driver: local
  keycloak_postgres_data:
    name: parlamd_keycloak_postgres_data
    driver: local
  backend_logs:
    name: parlamd_backend_logs
    driver: local

services:
  # =========================================================================
  # POSTGRESQL - Banco do Keycloak (CORRIGIDO)
  # =========================================================================
  keycloak-postgres:
    image: postgres:15-alpine
    container_name: parlamd-keycloak-postgres
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak123
      POSTGRES_HOST_AUTH_METHOD: trust
      PGDATA: /var/lib/postgresql/data/pgdata
      # Configuracoes para melhor performance e estabilidade
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=C --lc-ctype=C"
    volumes:
      - keycloak_postgres_data:/var/lib/postgresql/data/pgdata
    networks:
      - parlamd-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak -d keycloak -h localhost"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
    command: >
      postgres
      -c max_connections=200
      -c shared_buffers=128MB
      -c effective_cache_size=256MB
      -c log_statement=none
      -c log_min_duration_statement=-1
      -c log_checkpoints=off
      -c log_connections=off
      -c log_disconnections=off
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # =========================================================================
  # KEYCLOAK - Servidor de Autenticacao (CORRIGIDO)
  # =========================================================================
  keycloak:
    image: quay.io/keycloak/keycloak:23.0.7
    container_name: parlamd-keycloak
    environment:
      # Configuracoes do banco
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-postgres:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak123
      KC_DB_SCHEMA: public
      
      # Configuracoes de administracao
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin123
      
      # Configuracoes de desenvolvimento - SIMPLIFICADAS
      KC_HOSTNAME_STRICT: false
      KC_HOSTNAME_STRICT_HTTPS: false
      KC_HTTP_ENABLED: true
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: false
      KC_PROXY: edge
      KC_LOG_LEVEL: WARN
      
      # Configuracoes de performance
      KC_CACHE: local
      KC_TRANSACTION_XA_ENABLED: false
      
      # JVM Settings otimizadas
      JAVA_OPTS_APPEND: "-Dkeycloak.profile.feature.upload_scripts=enabled -Xms256m -Xmx1g -XX:MetaspaceSize=96M -XX:MaxMetaspaceSize=256m -Djava.net.preferIPv4Stack=true"
      
    command:
      - start-dev
      - --import-realm
      - --http-enabled=true
      - --hostname-strict=false
      - --hostname-strict-https=false
      - --health-enabled=true
      - --log-level=WARN
      
    volumes:
      - ./docker/keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    ports:
      - "8080:8080"
    networks:
      - parlamd-network
    depends_on:
      keycloak-postgres:
        condition: service_healthy
    restart: unless-stopped
    # HEALTHCHECK CORRIGIDO - usa endpoint mais simples
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/ || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # =========================================================================
  # MONGODB - Banco Principal (OK)
  # =========================================================================
  mongodb:
    image: mongo:7.0-jammy
    container_name: parlamd-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: parlamd
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - parlamd-network
    command: 
      - mongod
      - --auth
      - --bind_ip_all
      - --wiredTigerCacheSizeGB
      - "0.5"
      - --quiet
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--authenticationDatabase", "admin", "-u", "admin", "-p", "admin123", "--eval", "db.adminCommand('ping')", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # =========================================================================
  # RABBITMQ - Mensageria (CORRIGIDO - USA VHOST PADRAO)
  # =========================================================================
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: parlamd-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
      # REMOVIDO: RABBITMQ_DEFAULT_VHOST - usa o padrao "/"
      # Configuracoes para reduzir logs verbosos
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: "-rabbit log_levels [{connection,error},{default,warning}]"
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - parlamd-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # =========================================================================
  # REDIS - Cache (OK)
  # =========================================================================
  redis:
    image: redis:7.2-alpine
    container_name: parlamd-redis
    command: 
      - redis-server
      - --requirepass
      - redis123
      - --maxmemory
      - 256mb
      - --maxmemory-policy
      - allkeys-lru
      - --save
      - ""
      - --appendonly
      - "no"
    environment:
      REDIS_PASSWORD: redis123
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - parlamd-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "redis123", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # =========================================================================
  # BACKEND - Aplicacao Principal (RABBITMQ CORRIGIDO)
  # =========================================================================
  parlamd-backend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILD_DATE=2025-08-13
        - VCS_REF=fase3-corrigida
    container_name: parlamd-backend
    environment:
      # Profile de desenvolvimento
      SPRING_PROFILES_ACTIVE: docker
      
      # MongoDB
      SPRING_DATA_MONGODB_URI: mongodb://admin:admin123@mongodb:27017/parlamd?authSource=admin&retryWrites=true&w=majority
      
      # RabbitMQ - CORRIGIDO PARA USAR VHOST PADRAO
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME: guest
      SPRING_RABBITMQ_PASSWORD: guest
      SPRING_RABBITMQ_VIRTUAL_HOST: /
      
      # Redis
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      SPRING_DATA_REDIS_PASSWORD: redis123
      
      # OAuth2/Keycloak - CONFIGURACAO FLEXIVEL
      OAUTH2_ENABLED: false
      KEYCLOAK_AUTH_URL: http://keycloak:8080
      KEYCLOAK_REALM: parlamd
      KEYCLOAK_CLIENT_ID: parlamd-backend
      KEYCLOAK_ISSUER_URI: http://keycloak:8080/realms/parlamd
      KEYCLOAK_JWK_SET_URI: http://keycloak:8080/realms/parlamd/protocol/openid-connect/certs
      
      # URLs permitidas
      FRONTEND_URL: http://localhost:4200
      FRONTEND_URL_DEV: http://localhost:3000
      
      # JVM otimizada
      JAVA_OPTS: "-Xms512m -Xmx2g -XX:+UseG1GC -XX:+UseStringDeduplication -XX:MaxMetaspaceSize=256m -Djava.net.preferIPv4Stack=true"
      
      # Logging reduzido
      LOG_LEVEL_ROOT: WARN
      LOG_LEVEL_APP: INFO
      LOG_LEVEL_SECURITY: WARN
      LOGGING_LEVEL_ORG_APACHE_HTTP: WARN
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB: WARN
      
    ports:
      - "8081:8081"
    volumes:
      - backend_logs:/app/logs
    networks:
      - parlamd-network
    # DEPENDENCIAS CORRIGIDAS - nao espera Keycloak estar healthy
    depends_on:
      mongodb:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      keycloak:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8081/actuator/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
